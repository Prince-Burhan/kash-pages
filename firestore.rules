rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    // Admin collection - only admins can read/write
    match /admins/{userId} {
      allow read: if isAdmin();
      allow write: if false;  // Cannot be modified except by Firebase console
      allow delete: if false; // Cannot be deleted
    }

    // Landing pages - published pages readable by all, writes admin-only
    match /landingPages/{document=**} {
      // Public can read published pages (for rendering)
      allow read: if resource.data.status == 'published';

      // Admin can read/write all pages (including drafts)
      allow read, write: if isAdmin();

      // Admin can delete
      allow delete: if isAdmin();

      // Validate data on write
      allow create, update: if isAdmin() && validPageData();
    }

    // Validation function for landing page data
    function validPageData() {
      let data = request.resource.data;
      return (
        data.slug is string && data.slug.size() > 1 && data.slug.size() < 51
        && data.title is string && data.title.size() > 0
        && data.businessName is string && data.businessName.size() > 0
        && data.businessCategory is string
        && data.businessLocation is string
        && data.metaDescription is string && data.metaDescription.size() >= 20 && data.metaDescription.size() <= 160
        && data.ogImage is string
        && data.htmlContent is string && data.htmlContent.size() > 0
        && data.status in ['draft', 'published', 'archived']
        && data.createdAt is timestamp
        && data.updatedAt is timestamp
      );
    }

    // Site metadata - only admins can write, anyone can read
    match /siteMetadata/{document=**} {
      allow read: if true;  // Public can read
      allow write: if isAdmin();
    }

    // Audit logs - only admins can read, auto-written by backend
    match /auditLogs/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
      allow delete: if false;  // Audit logs are immutable
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
